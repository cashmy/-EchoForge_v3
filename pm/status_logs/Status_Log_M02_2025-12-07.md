# Status Log — M02 — 2025-12-07 20:10 UTC

## 1. Context
- Milestone: M02 — Processing Pipeline (EF-02/03/04/05 + INF-02/04)
- Related Tasks: M02-T01 through M02-T02a (active focus), future tasks T03–T12 pending
- Specs Referenced: `EF02_TranscriptionService_Spec` (derived), `INF04_LlmGateway_Spec_v1.0`, `EF06_EntryStore_Spec_v1.1`, `INF01_ConfigService_Spec_v1.0`
- Runtime Shape(s): ShapeA_LocalDev (local dev), ShapeB_DesktopElectron (target)
- ETS Profiles: ETS-Pipeline, ETS-LLM

## 2. What Was Attempted
- Replaced the INF-04 transcription stub with a faster-whisper backed client, including proper configuration plumbing via INF-01 (`backend/app/infra/llm_gateway/whisper_client.py`).
- Wired the gateway entry points (`backend/app/infra/llm_gateway/__init__.py`) so `transcribe_audio` invokes Whisper, translates exceptions into the EF-02 error taxonomy, and exposes language/model/duration metadata.
- Updated the EF-02 transcription worker (`backend/app/jobs/transcription_worker.py`) to consume the new gateway output, persist transcripts/segments/metadata to EF-06, roll files between watch folders, and enqueue normalization jobs.
- Added unit coverage for the whisper client, gateway wrapper, and worker (see `tests/unit/test_whisper_client.py`, `tests/unit/test_llm_gateway.py`, `tests/unit/test_transcription_worker.py`).
- Documented configuration knobs (`.env.example`, README) and added decision records defining Whisper config sources plus marker tooling (`pm/decisions/2025-12-07_inf04_whisper_config_source.md`, `pm/decisions/2025-12-07_inf04_whisper_integration.md`, `pm/decisions/2025-12-07_ef_inf_marker_tooling.md`).
- Captured EF-02 Whisper ETS guidance in `tests/README.md`, describing how to run the worker against the two bundled WAV fixtures inside `watch_roots/audio/incoming/`.

## 3. Outcomes
- INF-04 gateway now conditionally runs real Whisper models, with configuration controlled by YAML profiles and `ECHOFORGE_WHISPER_*` overrides. Non-Whisper environments still fall back to the stub.
- EF-02 worker respects INF-04 outputs, normalizes segments into `start_ms`/`end_ms`, logs capture events, and chains into EF-04 via `echo.normalize_entry` jobs.
- Test suites validated gateway and worker behavior across success paths and multiple error classes (timeouts, rate limits, generic failures).
- ETS instructions exist for running local WAV fixtures, helping future verification of the real audio pipeline.
- Fixed the faster-whisper integration gap by removing the unsupported `temperature_increment_on_fallback` decode option and installing the optional dependency inside the project venv so runtime executes without manual patching.
- Completed M02-T02b wiring: INF-01 profiles now expose `llm.whisper.transcript_output_root`, EF-02 writes transcripts/segment JSON files atomically, and EF-06 entries capture `verbatim_path` + preview text per spec.

## 4. Issues / Blockers
- Remaining subtask work: (a) ensure EF-02 worker persistence is exercised against the real EF-06 datastore (currently in-memory); (b) propagate Whisper readiness checks into the desktop host so EF-07 surfaces clear UX when the dependency is missing; (c) determine long-term retention/cleanup rules for transcript artifacts once EF-06 entries are archived.
- GPU/runtime considerations for faster-whisper (if moving beyond CPU) are noted but not yet resolved; may need additional INF-04 decisions if production requires hardware acceleration.
- Windows Developer Mode is still disabled, so the HuggingFace cache falls back to copy mode with extra disk usage. Track whether enabling Developer Mode (or setting `HF_HUB_DISABLE_SYMLINKS_WARNING=1`) is acceptable for long-running ETS sessions.

## 5. Next Steps
- Push the EF-06 Postgres adapter work item so the transcription worker can persist outputs beyond the in-memory gateway during desktop/E2E trials.
- Fold the EF-02 transcription + Whisper steps into EF-07 desktop orchestration so QA can trigger them via the host UI instead of ad-hoc scripts.
- Begin planning for EF-03/EF-04 tasks (document extraction + normalization) once EF-02 transcription is stable, including integration tests that chain through INF-02 job queue.
- Decide on a long-term approach for the HuggingFace cache warning (enable Developer Mode vs. env override) before scaling ETS runs.
- Document transcript retention/cleanup policies (likely milestone MG06) so long-lived desktops do not accumulate unbounded filesystem artifacts.

## 6. ETS Dry-Run Notes (2025-12-07)
- `20250907115516.WAV` (oracle documentary clip): processed via EF-02 worker with entry `f5b6f542-d610-4b3c-9a53-5806c26e715f`, `processing_ms = 200022`, `duration_ms = 356800`, detected language `en`, confidence `1.0`. Transcript preview: “Last night I was watching a television episode on the History Discovery Channel's combination... different oracle sites during ancient Greece civilization…”. File rolled from `processing/` to `processed/` and `echo.normalize_entry` job enqueued (`correlation_id=ets-whisper-006`).
- `20250908132309.WAV` (LLM hallucination explainer clip): processed with entry `f900286e-e9ad-42b9-a6e1-8950fe4b8e29`, `processing_ms = 34795`, `duration_ms = 62784`, detected language `en`, confidence `1.0`. Transcript preview: “Let's write an introductory-level article about the real cause and root issues for hallucinations inside of LLM…”. Downstream normalization job enqueued under `correlation_id=ets-whisper-005`.
- Both ETS runs persisted transcript files + segment JSON into the configured transcript root, and EF-06 records now expose `verbatim_path` for UI download links.
