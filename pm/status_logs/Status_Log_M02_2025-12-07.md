
# Status Log — M02 — 2025-12-07 23:59 UTC

## 1. Context
- Milestone: M02 — Processing Pipeline
- Active Task: M02-T07 (LLM Gateway integration for EF-05 semantics)
- Specs Referenced: `EF05_GptEntrySemanticService_Spec_v1.0`, `INF04_LlmGateway_Spec_v1.0`, `EF06_EntryStore_Spec_v1.1`, `INF04_LlmGateway_Contracts_Addendum_v1.0`

## 2. What Was Attempted
- Extended INF-04 gateway (`backend/app/infra/llm_gateway/__init__.py`) to emit structured JSON (summary, display title, tags, classification) and parse provider responses with validation + fallbacks.
- Updated EF-06 models/gateways to store `semantic_tags`, type/domain labels, and model provenance so EF-05 writes mirror EF-02/03/04 persistence and capture events.
- Enhanced EF-05 semantic worker to request prompts per mode, persist tags/classification metadata, add retry/backoff handling for INF-04 error classes, and log capture metadata.
- Added targeted unit coverage (`tests/unit/test_llm_gateway.py`, `tests/unit/test_semantic_worker.py`) plus refreshed ETS guidance inside `tests/README.md` for mocking INF-04 responses end-to-end.

## 3. Outcomes
- Semantic gateway now routes through a single execution path, producing canonical JSON payloads that EF-05 can consume even when provider drivers change. Stub provider returns deterministic tags/classifications for dev/CI.
- EF-06 persistence layer keeps semantic summary/tags/classification fields synchronized between in-memory and Postgres gateways, including pipeline status updates and capture events consistent with prior stages.
- Semantic worker gracefully retries retryable INF-04 errors with exponential backoff, records attempt counts, and saves classification metadata when available.
- Unit test suite covers the new parsing/retry paths, locking down behavior before real provider integrations land. ETS documentation highlights how to verify the flow using mock INF-04 responses.

## 4. Issues / Blockers
- None blocking M02-T07 completion. Future work will involve real provider drivers and broader ETS once EF-05 classification specs (M02-T08/T09) finalize.

## 5. Next Steps
- Kick off M02-T08 to formalize the semantic operation contract (payload schema, options, structured outputs) ahead of classification tasks.
- Extend ETS scenarios to chain EF-05 semantics after normalization within a single job sequence once EF-06 Postgres migrations land in QA environments.
- Coordinate with MG06 to document retention policies for semantic artifacts and capture metadata once the full pipeline is operational.

---
# Status Log — M02 — 2025-12-07 20:10 UTC

## 1. Context
- Milestone: M02 — Processing Pipeline (EF-02/03/04/05 + INF-02/04)
- Related Tasks: M02-T01 through M02-T02a (active focus), future tasks T03–T12 pending
- Specs Referenced: `EF02_TranscriptionService_Spec` (derived), `INF04_LlmGateway_Spec_v1.0`, `EF06_EntryStore_Spec_v1.1`, `INF01_ConfigService_Spec_v1.0`
- Runtime Shape(s): ShapeA_LocalDev (local dev), ShapeB_DesktopElectron (target)
- ETS Profiles: ETS-Pipeline, ETS-LLM

## 2. What Was Attempted
- Replaced the INF-04 transcription stub with a faster-whisper backed client, including proper configuration plumbing via INF-01 (`backend/app/infra/llm_gateway/whisper_client.py`).
- Wired the gateway entry points (`backend/app/infra/llm_gateway/__init__.py`) so `transcribe_audio` invokes Whisper, translates exceptions into the EF-02 error taxonomy, and exposes language/model/duration metadata.
- Updated the EF-02 transcription worker (`backend/app/jobs/transcription_worker.py`) to consume the new gateway output, persist transcripts/segments/metadata to EF-06, roll files between watch folders, and enqueue normalization jobs.
- Added unit coverage for the whisper client, gateway wrapper, and worker (see `tests/unit/test_whisper_client.py`, `tests/unit/test_llm_gateway.py`, `tests/unit/test_transcription_worker.py`).
- Documented configuration knobs (`.env.example`, README) and added decision records defining Whisper config sources plus marker tooling (`pm/decisions/2025-12-07_inf04_whisper_config_source.md`, `pm/decisions/2025-12-07_inf04_whisper_integration.md`, `pm/decisions/2025-12-07_ef_inf_marker_tooling.md`).
- Captured EF-02 Whisper ETS guidance in `tests/README.md`, describing how to run the worker against the two bundled WAV fixtures inside `watch_roots/audio/incoming/`.

## 3. Outcomes
- INF-04 gateway now conditionally runs real Whisper models, with configuration controlled by YAML profiles and `ECHOFORGE_WHISPER_*` overrides. Non-Whisper environments still fall back to the stub.
- EF-02 worker respects INF-04 outputs, normalizes segments into `start_ms`/`end_ms`, logs capture events, and chains into EF-04 via `echo.normalize_entry` jobs.
- Test suites validated gateway and worker behavior across success paths and multiple error classes (timeouts, rate limits, generic failures).
- ETS instructions exist for running local WAV fixtures, helping future verification of the real audio pipeline.
- Fixed the faster-whisper integration gap by removing the unsupported `temperature_increment_on_fallback` decode option and installing the optional dependency inside the project venv so runtime executes without manual patching.
- Completed M02-T02b wiring: INF-01 profiles now expose `llm.whisper.transcript_output_root`, EF-02 writes transcripts/segment JSON files atomically, and EF-06 entries capture `verbatim_path` + preview text per spec.

## 4. Issues / Blockers
- Remaining subtask work: (a) ensure EF-02 worker persistence is exercised against the real EF-06 datastore (currently in-memory); (b) propagate Whisper readiness checks into the desktop host so EF-07 surfaces clear UX when the dependency is missing; (c) determine long-term retention/cleanup rules for transcript artifacts once EF-06 entries are archived.
- GPU/runtime considerations for faster-whisper (if moving beyond CPU) are noted but not yet resolved; may need additional INF-04 decisions if production requires hardware acceleration.
- Windows Developer Mode is still disabled, so the HuggingFace cache falls back to copy mode with extra disk usage. Track whether enabling Developer Mode (or setting `HF_HUB_DISABLE_SYMLINKS_WARNING=1`) is acceptable for long-running ETS sessions.

## 5. Next Steps
- Push the EF-06 Postgres adapter work item so the transcription worker can persist outputs beyond the in-memory gateway during desktop/E2E trials.
- Fold the EF-02 transcription + Whisper steps into EF-07 desktop orchestration so QA can trigger them via the host UI instead of ad-hoc scripts.
- Begin planning for EF-03/EF-04 tasks (document extraction + normalization) once EF-02 transcription is stable, including integration tests that chain through INF-02 job queue.
- Decide on a long-term approach for the HuggingFace cache warning (enable Developer Mode vs. env override) before scaling ETS runs.
- Document transcript retention/cleanup policies (likely milestone MG06) so long-lived desktops do not accumulate unbounded filesystem artifacts.

## 6. ETS Dry-Run Notes (2025-12-07)
- `20250907115516.WAV` (oracle documentary clip): processed via EF-02 worker with entry `f5b6f542-d610-4b3c-9a53-5806c26e715f`, `processing_ms = 200022`, `duration_ms = 356800`, detected language `en`, confidence `1.0`. Transcript preview: “Last night I was watching a television episode on the History Discovery Channel's combination... different oracle sites during ancient Greece civilization…”. File rolled from `processing/` to `processed/` and `echo.normalize_entry` job enqueued (`correlation_id=ets-whisper-006`).
- `20250908132309.WAV` (LLM hallucination explainer clip): processed with entry `f900286e-e9ad-42b9-a6e1-8950fe4b8e29`, `processing_ms = 34795`, `duration_ms = 62784`, detected language `en`, confidence `1.0`. Transcript preview: “Let's write an introductory-level article about the real cause and root issues for hallucinations inside of LLM…”. Downstream normalization job enqueued under `correlation_id=ets-whisper-005`.
- Both ETS runs persisted transcript files + segment JSON into the configured transcript root, and EF-06 records now expose `verbatim_path` for UI download links.

---

# Status Log — M02 — 2025-12-07 22:45 UTC

## 1. Context
- Milestone: M02 — Processing Pipeline
- Active Topics: EF-02 verbatim preview behavior (MI99-T09), EF-03 implementation readiness (M02-T04)
- Specs Referenced: `EF06_EntryStore_Spec_v1.1`, `M02_Processing_Pipeline_Tasks_v1.0.md`, MI99 backlog addendum

## 2. What Was Attempted
- Reviewed EF-02 transcription worker implementation to confirm verbatim preview handling now that EF-03 also externalizes text.
- Cross-checked MI99-T09 guidance and INF-01 config knobs to ensure the preview limit is consistent across EF-02 and EF-03 (current limit: 400 chars with ellipsis when truncated).
- Audited `M02_Processing_Pipeline_Tasks_v1.0.md` to inventory remaining EF-03 scope and verify no blockers/decisions were pending for M02-T04 kickoff.

## 3. Outcomes
- Confirmed EF-02 already satisfies the “first chunk with ellipsis” rule: `_build_verbatim_preview` trims to 400 characters, mirroring EF-03 logic. No additional code change required; preview chunk size deemed sufficient by stakeholders.
- Documented that EF-03 worker implementation (M02-T04) remains the primary outstanding build task under the milestone; contract/specs are ready, so work can proceed as soon as resources free up.
- Validated there are no unresolved governance decisions blocking M02 progress; prior Whisper/externalization decisions cover current scope.

## 4. Issues / Blockers
- None at this time. Remaining work items are pending simply because they have not been started yet (EF-03 worker, EF-04/05 follow-ons, pipeline logging/tests).

## 5. Next Steps
- Schedule M02-T04 implementation: stand up the document extraction worker, filesystem artifact handling, EF-06 updates, and associated tests.
- Once EF-03 is underway, plan subsequent tasks (M02-T05/T06 normalization, M02-T07–T09 semantics) so the pipeline can flow end-to-end.
 
## 6. Notes
- MI99-T09 requirement (“always emit ~400-char preview or ellipsis”) is satisfied for both EF-02 and EF-03; EF-05 can overwrite previews later with semantic summaries when available.

---

# Status Log — M02 — 2025-12-07 23:30 UTC

## 1. Context
- Milestone: M02 — Processing Pipeline
- Active Task: M02-T04 (EF-03 extraction worker implementation)
- Specs Referenced: `EF06_EntryStore_Spec_v1.1`, `M02_Processing_Pipeline_Tasks_v1.0.md`

## 2. What Was Attempted
- Added INF-01 knobs for document segment caching (`segment_cache_threshold_bytes`) across defaults and dev/desktop profiles.
- Extended EF-03 worker to optionally offload large `extraction_segments` payloads to disk, storing references + byte counts in `extraction_metadata` per spec.
- Updated EF-03 unit tests to cover verbatim artifacts and the new segment cache path, ensuring chunk counts are preserved even when segments are externalized.

## 3. Outcomes
- Worker now records per-entry `segment_count`, writes oversized segments to `documents.segment_cache_root`, and logs the cache artifact path/size for downstream retention jobs.
- INF-01 profiles expose the threshold knob so deployments can tune when caching kicks in; default set to 512 KiB.
- Tests `tests/unit/test_extraction_worker.py` expanded to 4 cases covering success, caching, and failure paths (all passing via `python -m pytest tests/unit/test_extraction_worker.py`). EF-02 regression suite also re-run to guard against regressions.

## 4. Issues / Blockers
- None introduced; remaining EF-03 scope includes richer parser coverage (docx/pdf fixtures) and ETS integration, to be handled next.

## 5. Next Steps
- Implement additional extraction fixtures (PDF/DOCX/OCR) plus error taxonomy tests.
- Wire retention/cleanup stories for cached segments as part of MG06 or a follow-on task.
- Continue marching through M02-T04 until EF-03 worker is feature-complete, then move to normalization tasks.

---

# Status Log — M02 — 2025-12-07 23:55 UTC

## 1. Context
- Milestone: M02 — Processing Pipeline
- Active Task: M02-T04
- Focus: EF-03 parser coverage (DOCX/PDF + OCR handling)

## 2. What Was Attempted
- Added dedicated EF-03 service tests (`tests/unit/test_ef03_extraction_service.py`) that generate docx fixtures on the fly, exercise pdfminer segmentation, and assert OCR-required error paths.
- Installed `pdfminer.six`, `python-docx`, and transitive deps inside the project venv so the new tests and worker runtime can execute without manual setup.
- Re-ran the EF-03 worker + EF-02 worker suites to ensure no regressions after introducing the new dependencies.

## 3. Outcomes
- DOCX and PDF extraction paths are now validated via automated tests, including the retryable `ocr_required` condition when PDFs lack a text layer.
- CI/local environments have the necessary parser libraries, closing the gap between spec expectations and available tooling.
- All unit suites (EF-03 service, EF-03 worker, EF-02 worker) are passing under the updated dependency set.

## 4. Issues / Blockers
- None; remaining work involves richer fixtures (scanned PDFs, large docs) and ETS coverage.

## 5. Next Steps
- Add ETS-ready document fixtures (multi-page PDF, OCR sample) and extend worker tests to cover those files directly.
- Begin wiring OCR fallback hooks (e.g., Tesseract integration) once the deterministic parsers are fully covered.

---

# Status Log — M02 — 2025-12-07 23:59 UTC

## 1. Context
- Milestone: M02 — Processing Pipeline
- Active Task: M02-T04
- Focus: Large-document safety + EF-06 storage limits

## 2. What Was Attempted
- Added a configurable `documents.max_inline_chars` knob (default 200k) to INF-01 loader and threaded it into the EF-03 worker.
- Implemented worker-side truncation helpers so gigantic extracts are written to disk in full but only stored inline up to the configured limit, emitting metadata describing the truncation event.
- Extended `tests/unit/test_extraction_worker.py` with high-volume fixtures plus metadata override coverage to keep ETS expectations executable.

## 3. Outcomes
- EF-03 now guards EF-06 rows from ballooning when PDFs/DOCX exceed the inline threshold while still persisting the full verbatim artifact to disk.
- Metadata includes `truncated`, `inline_char_limit`, and `extracted_char_count`, enabling downstream services to decide when to rehydrate from the verbatim file instead of the inline blob.
- Extraction worker unit suite expanded to 6 tests, all passing locally (`py -m pytest tests/unit/test_extraction_worker.py`).

## 4. Issues / Blockers
- None for truncation; OCR fallback still pending once tesseract binding decision lands.

## 5. Next Steps
- Wire ETS fixtures that exercise the truncation metadata end-to-end (EntryStore + normalization hook).
- Follow up with retention/cleanup stories now that inline/file bifurcation exists.
